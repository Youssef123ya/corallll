{% extends "base.html" %}

{% block title %}Coral Reef Health Guardian - AI-Powered Coral Monitoring{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <h1 class="display-4 fw-bold mb-4">
                    <i class="fas fa-coral text-warning"></i>
                    Coral Reef Health Guardian
                </h1>
                <p class="lead mb-4">
                    Advanced AI-powered system for monitoring and classifying coral reef health status. 
                    Upload coral images to get instant health assessments and contribute to marine conservation efforts.
                </p>
                <div class="d-grid d-md-flex gap-3">
                    <button class="btn btn-primary btn-lg" onclick="scrollToUpload()">
                        <i class="fas fa-upload"></i> Analyze Coral Image
                    </button>
                    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-light btn-lg">
                        <i class="fas fa-chart-line"></i> View Dashboard
                    </a>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="text-center">
                    <img src="/static/images/coral-hero.jpg" alt="Coral Reef" class="img-fluid rounded-3 shadow" 
                         style="max-height: 400px; object-fit: cover;" 
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDQwMCAzMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI0MDAiIGhlaWdodD0iMzAwIiBmaWxsPSIjNDVCN0QxIi8+Cjx0ZXh0IHg9IjIwMCIgeT0iMTUwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSJ3aGl0ZSIgZm9udC1zaXplPSIyNCIgZm9udC1mYW1pbHk9IkFyaWFsIj5Db3JhbCBSZWVmPC90ZXh0Pgo8L3N2Zz4='">
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Features Section -->
<section class="py-5">
    <div class="container">
        <div class="row text-center mb-5">
            <div class="col-12">
                <h2 class="display-5 fw-bold mb-3">Why Choose Our System?</h2>
                <p class="lead text-muted">Advanced AI technology meets marine conservation</p>
            </div>
        </div>
        
        <div class="row g-4">
            <div class="col-md-4">
                <div class="card h-100 text-center">
                    <div class="card-body">
                        <div class="feature-icon">
                            <i class="fas fa-brain"></i>
                        </div>
                        <h5 class="card-title">AI-Powered Analysis</h5>
                        <p class="card-text">
                            Advanced deep learning models trained on thousands of coral images 
                            for accurate health classification and monitoring.
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card h-100 text-center">
                    <div class="card-body">
                        <div class="feature-icon">
                            <i class="fas fa-tachometer-alt"></i>
                        </div>
                        <h5 class="card-title">Real-Time Results</h5>
                        <p class="card-text">
                            Get instant coral health assessments with confidence scores 
                            and detailed analysis in seconds.
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card h-100 text-center">
                    <div class="card-body">
                        <div class="feature-icon">
                            <i class="fas fa-leaf"></i>
                        </div>
                        <h5 class="card-title">Conservation Impact</h5>
                        <p class="card-text">
                            Support marine conservation efforts with data-driven insights 
                            for coral reef protection and restoration.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Upload Section -->
<section class="py-5 bg-light" id="upload-section">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow-lg">
                    <div class="card-header text-center">
                        <h3 class="mb-0">
                            <i class="fas fa-camera"></i> Analyze Coral Health
                        </h3>
                        <p class="mb-0 mt-2 opacity-75">Upload a coral image to get instant health assessment</p>
                    </div>
                    <div class="card-body p-4">
                        <!-- Upload Form -->
                        <form id="upload-form" enctype="multipart/form-data">
                            <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()">
                                <input type="file" id="file-input" name="file" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
                                <div class="upload-content">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                                    <h5>Drag & Drop Your Coral Image</h5>
                                    <p class="text-muted mb-3">or click to browse files</p>
                                    <small class="text-muted">Supports: JPEG, PNG, JPG • Max size: 10MB</small>
                                </div>
                            </div>
                            
                            <!-- Selected File Info -->
                            <div id="file-info" class="mt-3" style="display: none;">
                                <div class="alert alert-info">
                                    <i class="fas fa-file-image"></i>
                                    <strong id="file-name"></strong> (<span id="file-size"></span>)
                                </div>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div id="upload-progress" class="mt-3" style="display: none;">
                                <div class="progress">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" style="width: 0%"></div>
                                </div>
                                <small class="text-muted mt-1 d-block">Analyzing coral health...</small>
                            </div>
                            
                            <!-- Submit Button -->
                            <div class="text-center mt-4">
                                <button type="submit" id="analyze-btn" class="btn btn-primary btn-lg px-5" disabled>
                                    <i class="fas fa-search"></i> Analyze Coral Health
                                </button>
                            </div>
                        </form>
                        
                        <!-- Results Section -->
                        <div id="results-section" class="mt-5" style="display: none;">
                            <hr>
                            <h4 class="text-center mb-4">
                                <i class="fas fa-chart-pie"></i> Analysis Results
                            </h4>
                            <div id="results-content">
                                <!-- Results will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Statistics Section -->
<section class="py-5">
    <div class="container">
        <div class="row text-center">
            <div class="col-md-3">
                <div class="stats-card mb-4">
                    <span class="stats-number">1,599</span>
                    <span class="stats-label">Training Images</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card mb-4">
                    <span class="stats-number">94.2%</span>
                    <span class="stats-label">Model Accuracy</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card mb-4">
                    <span class="stats-number">3</span>
                    <span class="stats-label">Health Classes</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card mb-4">
                    <span class="stats-number">&lt;100ms</span>
                    <span class="stats-label">Processing Time</span>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Call to Action -->
<section class="py-5 bg-primary text-white text-center">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <h2 class="display-5 fw-bold mb-3">Join the Conservation Effort</h2>
                <p class="lead mb-4">
                    Help protect coral reefs worldwide by contributing to our monitoring efforts. 
                    Every image analysis helps build a better understanding of coral health patterns.
                </p>
                <div class="d-grid d-md-flex gap-3 justify-content-center">
                    <a href="{{ url_for('dashboard') }}" class="btn btn-light btn-lg">
                        <i class="fas fa-chart-line"></i> Explore Data
                    </a>
                    <a href="/api/docs" class="btn btn-outline-light btn-lg" target="_blank">
                        <i class="fas fa-code"></i> API Access
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
// File upload handling
let selectedFile = null;

function scrollToUpload() {
    document.getElementById('upload-section').scrollIntoView({ behavior: 'smooth' });
}

// Drag and drop functionality
const uploadZone = document.getElementById('upload-zone');
const fileInput = document.getElementById('file-input');
const uploadForm = document.getElementById('upload-form');
const analyzeBtn = document.getElementById('analyze-btn');

// Prevent default drag behaviors
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    uploadZone.addEventListener(eventName, preventDefaults, false);
    document.body.addEventListener(eventName, preventDefaults, false);
});

// Highlight drop area when item is dragged over it
['dragenter', 'dragover'].forEach(eventName => {
    uploadZone.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
    uploadZone.addEventListener(eventName, unhighlight, false);
});

// Handle dropped files
uploadZone.addEventListener('drop', handleDrop, false);

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

function highlight(e) {
    uploadZone.classList.add('dragover');
}

function unhighlight(e) {
    uploadZone.classList.remove('dragover');
}

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    
    if (files.length > 0) {
        fileInput.files = files;
        handleFileSelect({ target: fileInput });
    }
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    
    if (!file) return;
    
    // Validate file type
    if (!file.type.startsWith('image/')) {
        showAlert('Please select a valid image file (JPEG, PNG, JPG)', 'error');
        return;
    }
    
    // Validate file size (10MB limit)
    if (file.size > 10 * 1024 * 1024) {
        showAlert('File size must be less than 10MB', 'error');
        return;
    }
    
    selectedFile = file;
    
    // Show file info
    document.getElementById('file-name').textContent = file.name;
    document.getElementById('file-size').textContent = formatBytes(file.size);
    document.getElementById('file-info').style.display = 'block';
    
    // Enable analyze button
    analyzeBtn.disabled = false;
    analyzeBtn.dataset.originalText = analyzeBtn.innerHTML;
    
    // Hide previous results
    document.getElementById('results-section').style.display = 'none';
}

// Form submission
uploadForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!selectedFile) {
        showAlert('Please select an image file', 'warning');
        return;
    }
    
    // Show loading state
    setLoading(analyzeBtn, true);
    document.getElementById('upload-progress').style.display = 'block';
    
    // Simulate progress
    simulateProgress();
    
    // Create form data
    const formData = new FormData();
    formData.append('file', selectedFile);
    
    try {
        const response = await fetch('/api/predict', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        displayResults(result);
        
    } catch (error) {
        console.error('Error:', error);
        showAlert(`Analysis failed: ${error.message}`, 'danger');
    } finally {
        // Hide loading state
        setLoading(analyzeBtn, false);
        document.getElementById('upload-progress').style.display = 'none';
    }
});

function simulateProgress() {
    const progressBar = document.querySelector('.progress-bar');
    let progress = 0;
    
    const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90;
        
        progressBar.style.width = progress + '%';
        
        if (progress >= 90) {
            clearInterval(interval);
        }
    }, 200);
}

function displayResults(result) {
    const resultsSection = document.getElementById('results-section');
    const resultsContent = document.getElementById('results-content');
    
    const badgeClass = getHealthBadgeClass(result.prediction);
    const healthScore = result.health_score || 0;
    
    resultsContent.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Prediction Result</h5>
                        <div class="mb-3">
                            <span class="health-badge ${badgeClass}">
                                ${result.prediction}
                            </span>
                        </div>
                        <div class="mb-2">
                            <strong>Confidence:</strong> ${(result.confidence * 100).toFixed(1)}%
                        </div>
                        <div class="mb-2">
                            <strong>Health Score:</strong> ${healthScore.toFixed(1)}/100
                        </div>
                        <small class="text-muted">
                            Model: ${result.model_type || 'AI'} • 
                            ${new Date(result.timestamp).toLocaleString()}
                        </small>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Class Probabilities</h5>
                        <canvas id="probabilities-chart" width="300" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Health Assessment Details</h5>
                        <div class="row">
                            ${Object.entries(result.probabilities || {}).map(([className, prob]) => `
                                <div class="col-md-4">
                                    <div class="text-center p-3">
                                        <div class="fs-4 fw-bold text-primary">${(prob * 100).toFixed(1)}%</div>
                                        <div class="text-muted">${className}</div>
                                        <div class="progress mt-2">
                                            <div class="progress-bar bg-${getProgressBarColor(className)}" 
                                                 style="width: ${prob * 100}%"></div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    resultsSection.style.display = 'block';
    resultsSection.scrollIntoView({ behavior: 'smooth' });
    
    // Create probabilities chart
    createProbabilitiesChart(result.probabilities || {});
}

function getProgressBarColor(className) {
    const colors = {
        'Healthy': 'success',
        'Unhealthy': 'warning',
        'Dead': 'danger'
    };
    return colors[className] || 'info';
}

function createProbabilitiesChart(probabilities) {
    const ctx = document.getElementById('probabilities-chart').getContext('2d');
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(probabilities),
            datasets: [{
                data: Object.values(probabilities),
                backgroundColor: [
                    '#28a745',  // Healthy - Green
                    '#ffc107',  // Unhealthy - Yellow
                    '#dc3545'   // Dead - Red
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + (context.parsed * 100).toFixed(1) + '%';
                        }
                    }
                }
            }
        }
    });
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Add animation classes to elements
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
        setTimeout(() => {
            card.classList.add('fade-in');
        }, index * 100);
    });
});
</script>
{% endblock %}